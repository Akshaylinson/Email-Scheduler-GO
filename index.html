

  <div class="row">
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header">Upload Subscribers (CSV)</div>
        <div class="card-body">
          <form id="uploadForm">
            <div class="mb-3">
              <input type="file" id="csvFile" name="file" accept=".csv" class="form-control" />
            </div>
            <button class="btn btn-primary" type="submit">Upload</button>
          </form>
          <div id="uploadResult" class="mt-2 text-muted"></div>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header">Schedule Newsletter</div>
        <div class="card-body">
          <form id="scheduleForm">
            <div class="mb-2">
              <input class="form-control" id="subject" placeholder="Subject">
            </div>
            <div class="mb-2">
              <textarea id="body" class="form-control" rows="4" placeholder="Body"></textarea>
            </div>
            <div class="mb-2">
              <input id="when" type="datetime-local" class="form-control" />
              <small class="form-text text-muted">Leave empty to send immediately.</small>
            </div>
            <button class="btn btn-success" type="submit">Schedule</button>
          </form>
          <div id="scheduleResult" class="mt-2 text-muted"></div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header">Jobs</div>
        <div class="card-body">
          <button id="refreshJobs" class="btn btn-sm btn-secondary mb-2">Refresh</button>
          <div id="jobsList" style="max-height:60vh; overflow:auto;"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Notes</div>
        <div class="card-body">
          If SMTP is not configured the server will mock sends and log them. To enable SMTP, set environment variables SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS, SMTP_FROM.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('uploadForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const f = document.getElementById('csvFile').files[0];
  if(!f){ alert('Select a CSV file'); return;}
  const fd = new FormData();
  fd.append('file', f);
  const res = await fetch('/upload', { method: 'POST', body: fd });
  const data = await res.json();
  document.getElementById('uploadResult').innerText = 'Added: ' + (data.added || 0);
});

document.getElementById('scheduleForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const subj = document.getElementById('subject').value;
  const body = document.getElementById('body').value;
  let when = document.getElementById('when').value;
  if(when){
    // convert local datetime-local to RFC3339 with timezone offset by using new Date()
    when = new Date(when).toISOString();
  } else { when = ''; }
  const res = await fetch('/schedule', {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify({ subject: subj, body: body, scheduled_at: when })
  });
  const j = await res.json();
  document.getElementById('scheduleResult').innerText = 'Queued: ' + (j.id || '');
  loadJobs();
});

document.getElementById('refreshJobs').addEventListener('click', loadJobs);

async function loadJobs(){
  const res = await fetch('/jobs');
  const jobs = await res.json();
  const el = document.getElementById('jobsList');
  el.innerHTML = '';
  jobs.forEach(j => {
    const d = new Date(j.scheduled_at*1000);
    const div = document.createElement('div');
    div.className = 'border rounded p-2 mb-2 bg-white';
    div.innerHTML = '<strong>'+j.subject+'</strong><br/><small>when: '+d.toLocaleString()+'</small><br/><small>status: '+j.status+'</small>';
    el.appendChild(div);
  });
}

loadJobs();
</script>
</body>
</html>

